<% layout("layouts/main") %>

<div class="w-full px-0 sm:px-4 py-6 sm:py-8 mx-auto">  <div class="flex flex-col lg:flex-row lg:justify-between lg:items-start gap-4 lg:gap-6 mb-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-primary dark:text-primary-400 transition-colors duration-300">Events</h1>
    
    <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3 sm:gap-4 w-full lg:w-auto">
      <!-- Search Input Container -->
      <div class="relative w-full sm:w-auto sm:min-w-[300px]">
        <input
          type="text"
          placeholder="Search events..."
          class="w-full py-2.5 sm:py-3 pl-4 sm:pl-5 pr-12 sm:pr-14 rounded-full border border-gray-300 dark:border-dark-border bg-white dark:bg-dark-surface text-gray-900 dark:text-dark-text-primary shadow-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary transition-colors duration-300 text-sm"
        />
        <button
          type="button"
          class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-primary hover:bg-primary/90 dark:bg-primary-500 dark:hover:bg-primary-600 text-white rounded-full p-2 shadow-md focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 transition-all duration-300 flex items-center justify-center"
          style="width: 32px; height: 32px;"
        >
          <i class="fas fa-search text-xs"></i>
        </button>
      </div>
        <!-- Club Filter -->
      <div class="w-full sm:w-auto sm:min-w-[160px]">
        <select
          id="clubFilter"
          class="w-full py-2.5 sm:py-3 px-4 sm:px-5 rounded-full border border-gray-300 dark:border-dark-border bg-white dark:bg-dark-surface text-gray-900 dark:text-dark-text-primary shadow-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary transition-colors duration-300 text-sm appearance-none cursor-pointer"
          style="background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 4 5\'><path fill=\'%23666\' d=\'M2 0L0 2h4zm0 5L0 3h4z\'/></svg>'); background-repeat: no-repeat; background-position: right 1rem center; background-size: 0.65em auto;"
        >
          <option value="">All Clubs</option>
          <% const eventClubs = new Set(events.map(event => event.club?.name).filter(Boolean)); %>
          <% eventClubs.forEach(clubName => { %>
            <option value="<%= clubName %>"><%= clubName %></option>
          <% }); %>
        </select>
      </div>
    </div>
    
    <!-- Create Event Button -->
    <a
      href="/event/create"
      class="bg-green-600 hover:bg-green-700 dark:bg-green-500 dark:hover:bg-green-600 text-white font-semibold py-2.5 sm:py-3 px-4 sm:px-6 rounded-full shadow-lg transition-all duration-300 flex items-center gap-2 mt-4 sm:mt-0 w-full sm:w-auto justify-center min-w-[140px]"
    >
      <i class="fas fa-plus-circle"></i> <span class="hidden xs:inline">Create Event</span>
    </a>
  </div>

  <!-- Event Grid -->
  <div class="grid grid-cols-1 xs:grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 sm:gap-8">
    <% events.filter(event => new Date(event.endDate) >= new Date()).forEach(event => { 
      const isExpired = new Date(event.endDate) < new Date(); // Check if event is expired
    %>    <div
      class="bg-white dark:bg-dark-surface shadow-lg rounded-xl overflow-hidden hover:shadow-2xl transition-all duration-300 flex flex-col border border-gray-100 dark:border-dark-border
      <%= isExpired ? 'grayscale opacity-50' : '' %>"
    >
      <!-- Event Image -->
      <img
        src="<%= event.image %>"
        alt="<%= event.title %>"
        class="w-full h-40 sm:h-56 object-cover"
      />

      <!-- Event Details -->
      <div class="p-4 sm:p-5 flex flex-col justify-between flex-grow">
        <div>
          <h2 class="text-lg sm:text-2xl font-semibold text-gray-900 dark:text-dark-text-primary mb-1 transition-colors duration-300">
            <%= event.title %>
          </h2>
          <% if (event.club && event.club.name) { %>
          <div class="text-xs sm:text-sm font-regular text-gray-500 dark:text-dark-text-secondary mb-2 flex items-center gap-1 transition-colors duration-300">
            <a href="/club/<%= event.club.id %>/about" class="hover:underline hover:text-blue-600 dark:hover:text-primary-400 transition-colors duration-300">
              <%= event.club.name %>
            </a>
            <svg class="inline-block ml-1" width="14" height="14" viewBox="0 0 24 24" fill="var(--color-primary)" xmlns="http://www.w3.org/2000/svg">
              <circle cx="12" cy="12" r="12" fill="var(--color-primary)" />
              <path d="M17 9l-5.2 5.2-2.8-2.8" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
            </svg>
          </div>
          <% } %>
          <div class="w-20 h-[2px] bg-gray-200 dark:bg-dark-border my-2 mx-0 transition-colors duration-300"></div>
          <div class="flex items-center flex-wrap gap-x-1 gap-y-1 mt-3 text-[10px] sm:text-[11px] text-black dark:text-dark-text-primary font-medium transition-colors duration-300">
            <span class="flex items-center gap-1">
              <i class="far fa-calendar-alt text-[13px]"></i>
              <%= new Date(event.startDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) %>
              <% if (event.endDate && new Date(event.endDate).toDateString() !== new Date(event.startDate).toDateString()) { %>
                - <%= new Date(event.endDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) %>
              <% } %>
            </span>
            <span class="mx-1">|</span>
            <span class="flex items-center gap-1">
              <i class="far fa-clock text-[13px]"></i>
              <%= event.startTime ? (new Date('1970-01-01T' + event.startTime).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })) : 'Time TBA' %> Onwards
            </span>
            <span class="mx-1">|</span>
            <span class="flex items-center gap-1">
              <i class="fas fa-map-marker-alt text-[13px]"></i>
              <%= event.location %>
            </span>
          </div>
          <% if (event.registeredUsers && event.registeredUsers.length > 0) { %>
          <div class="flex items-center mt-3">
            <% event.registeredUsers.forEach(function(user, idx) { %>
              <img src="<%= user.avatar || '/images/default-avatar.png' %>" alt="<%= user.name %>" class="w-7 h-7 sm:w-8 sm:h-8 rounded-full border-2 border-white -ml-2 first:ml-0 shadow" />
            <% }) %>
            <% if (event.registeredUsersCount > 5) { %>
              <span class="w-7 h-7 sm:w-8 sm:h-8 rounded-full bg-gray-200 flex items-center justify-center text-xs font-semibold text-gray-700 -ml-2 border-2 border-white shadow">
                +<%= event.registeredUsersCount - 5 %>
              </span>
            <% } %>
            <span class="ml-3 text-xs text-gray-400">Already Registered</span>
          </div>
          <% } else { %>
          <div class="flex items-center mt-3">
            <span class="text-xs text-gray-400 italic">Be the first to register!</span>
          </div>
          <% } %>
        </div>

        <!-- View More Button (Disabled for expired events) -->
        <a
          href="/event/<%= event.id %>"
          class="mt-4 w-full text-center py-2 rounded-lg transition-all
          <%= isExpired ? 'bg-gray-400 cursor-not-allowed' : 'bg-primary text-white hover:bg-primary-dark' %>"
          <%= isExpired ? 'onclick="return false;"' : '' %>
        >
          View Details
        </a>
      </div>
    </div>
    <% }) %>
  </div>
</div>

<script>
      const searchInput = document.querySelector('input[type="text"]');
      const searchButton = document.querySelector('button[type="button"]');
      const clubFilter = document.querySelector('#clubFilter');

      // Event listeners
      searchInput.addEventListener('input', filterEvents);
      searchButton.addEventListener('click', filterEvents);
      clubFilter.addEventListener('change', filterEvents);

      // Allow Enter key to trigger search
      searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          filterEvents();
        }
      });

      function filterEvents() {
        const searchQuery = searchInput.value.toLowerCase().trim();
        const selectedClub = clubFilter.value.toLowerCase();
        const eventCards = document.querySelectorAll('.grid > div');

        eventCards.forEach(card => {
          const title = card.querySelector('h2').textContent.toLowerCase();
          const clubName = card.querySelector('a')?.textContent.toLowerCase() || '';

          const matchesSearch = !searchQuery || title.includes(searchQuery);
          const matchesClub = !selectedClub || clubName.includes(selectedClub);

          if (matchesSearch && matchesClub) {
            card.style.display = 'block';
          } else {
            card.style.display = 'none';
          }
        });
      }
    </script>