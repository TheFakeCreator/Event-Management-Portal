<% layout("layouts/main") %>

<div class="w-full px-0 sm:px-4 py-6 sm:py-8 mx-auto">
  <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-8">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-primary">Events</h1>
    <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 sm:gap-0 w-full sm:w-auto">
      <div class="relative flex flex-row items-center w-full sm:w-2/3 mb-2 sm:mb-0">
        <input
          type="text"
          placeholder="Search events..."
          class="w-full py-2 sm:py-3 px-4 sm:px-5 rounded-full border border-gray-300 shadow-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary text-sm"
        />
        <button
          class="bg-primary text-white translate-x-[-55%] rounded-full p-2 sm:p-3 shadow-md hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary flex items-center justify-center"
          style="height: 36px; width: 36px;"
        >
          <i class="fas fa-search text-regular"></i>
        </button>
      </div>
      <div class="w-full sm:w-1/4">
        <select
          id="clubFilter"
          class="w-full py-2 px-4 rounded-full border border-gray-300 shadow-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary text-sm"
        >
          <option value="">All Clubs</option>
          <% const eventClubs = new Set(events.map(event => event.club?.name).filter(Boolean)); %>
          <% eventClubs.forEach(clubName => { %>
            <option value="<%= clubName %>"><%= clubName %></option>
          <% }); %>
        </select>
      </div>
    </div>
    <a
      href="/event/create"
      class="bg-green-600 text-white font-semibold py-2 sm:py-3 px-4 sm:px-6 rounded-full shadow-lg hover:bg-green-700 transition-all flex items-center gap-2 mt-2 sm:mt-0 w-full sm:w-auto justify-center"
    >
      <i class="fas fa-plus-circle"></i> <span class="hidden xs:inline">Create Event</span>
    </a>
  </div>

  <!-- Event Grid -->
  <div class="grid grid-cols-1 xs:grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 sm:gap-8">
    <% events.filter(event => new Date(event.endDate) >= new Date()).forEach(event => { 
      const isExpired = new Date(event.endDate) < new Date(); // Check if event is expired
    %>
    <div
      class="bg-white shadow-lg rounded-xl overflow-hidden hover:shadow-2xl transition flex flex-col 
      <%= isExpired ? 'grayscale opacity-50' : '' %>"
    >
      <!-- Event Image -->
      <img
        src="<%= event.image %>"
        alt="<%= event.title %>"
        class="w-full h-40 sm:h-56 object-cover"
      />

      <!-- Event Details -->
      <div class="p-4 sm:p-5 flex flex-col justify-between flex-grow">
        <div>
          <h2 class="text-lg sm:text-2xl font-semibold text-gray-900 mb-1">
            <%= event.title %>
          </h2>
          <% if (event.club && event.club.name) { %>
          <div class="text-xs sm:text-sm font-regular text-gray-500 mb-2 flex items-center gap-1">
            <a href="/club/<%= event.club.id %>/about" class=" hover:underline">
              <%= event.club.name %>
            </a>
            <svg class="inline-block ml-1" width="14" height="14" viewBox="0 0 24 24" fill="var(--color-primary)" xmlns="http://www.w3.org/2000/svg">
              <circle cx="12" cy="12" r="12" fill="var(--color-primary)" />
              <path d="M17 9l-5.2 5.2-2.8-2.8" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
            </svg>
          </div>
          <% } %>
          <div class="w-20 h-[2px] bg-gray-200 my-2 mx-0"></div>
          <div class="flex items-center flex-wrap gap-x-1 gap-y-1 mt-3 text-[10px] sm:text-[11px] text-black font-medium">
            <span class="flex items-center gap-1">
              <i class="far fa-calendar-alt text-[13px]"></i>
              <%= new Date(event.startDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) %>
              <% if (event.endDate && new Date(event.endDate).toDateString() !== new Date(event.startDate).toDateString()) { %>
                - <%= new Date(event.endDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) %>
              <% } %>
            </span>
            <span class="mx-1">|</span>
            <span class="flex items-center gap-1">
              <i class="far fa-clock text-[13px]"></i>
              <%= event.startTime ? (new Date('1970-01-01T' + event.startTime).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })) : 'Time TBA' %> Onwards
            </span>
            <span class="mx-1">|</span>
            <span class="flex items-center gap-1">
              <i class="fas fa-map-marker-alt text-[13px]"></i>
              <%= event.location %>
            </span>
          </div>
          <% if (event.registeredUsers && event.registeredUsers.length > 0) { %>
          <div class="flex items-center mt-3">
            <% event.registeredUsers.forEach(function(user, idx) { %>
              <img src="<%= user.avatar || '/images/default-avatar.png' %>" alt="<%= user.name %>" class="w-7 h-7 sm:w-8 sm:h-8 rounded-full border-2 border-white -ml-2 first:ml-0 shadow" />
            <% }) %>
            <% if (event.registeredUsersCount > 5) { %>
              <span class="w-7 h-7 sm:w-8 sm:h-8 rounded-full bg-gray-200 flex items-center justify-center text-xs font-semibold text-gray-700 -ml-2 border-2 border-white shadow">
                +<%= event.registeredUsersCount - 5 %>
              </span>
            <% } %>
            <span class="ml-3 text-xs text-gray-400">Already Registered</span>
          </div>
          <% } else { %>
          <div class="flex items-center mt-3">
            <span class="text-xs text-gray-400 italic">Be the first to register!</span>
          </div>
          <% } %>
        </div>

        <!-- View More Button (Disabled for expired events) -->
        <a
          href="/event/<%= event.id %>"
          class="mt-4 w-full text-center py-2 rounded-lg transition-all
          <%= isExpired ? 'bg-gray-400 cursor-not-allowed' : 'bg-primary text-white hover:bg-primary-dark' %>"
          <%= isExpired ? 'onclick="return false;"' : '' %>
        >
          View Details
        </a>
      </div>
    </div>
    <% }) %>
  </div>
</div>

<script>
      document.querySelector('input').addEventListener('input', function () {
        filterEvents();
      });

      document.querySelector('#clubFilter').addEventListener('change', function () {
        filterEvents();
      });

      function filterEvents() {
        const searchQuery = document.querySelector('input').value.toLowerCase();
        const selectedClub = document.querySelector('#clubFilter').value.toLowerCase();
        const eventCards = document.querySelectorAll('.grid > div');

        eventCards.forEach(card => {
          const title = card.querySelector('h2').textContent.toLowerCase();
          const clubName = card.querySelector('a')?.textContent.toLowerCase() || '';

          if (
            (!searchQuery || title.includes(searchQuery)) &&
            (!selectedClub || clubName.includes(selectedClub))
          ) {
            card.style.display = 'block';
          } else {
            card.style.display = 'none';
          }
        });
      }
    </script>